<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>文字動画</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{margin:0;background:#000;color:#fff;font-family:monospace;overflow:hidden}
.controls{position:fixed;left:12px;top:12px;z-index:30;background:rgba(0,0,0,0.6);padding:10px;border-radius:8px;backdrop-filter: blur(4px);color:#fff}
.controls label{display:block;margin:6px 0;font-size:13px}
.controls input[type="range"]{width:200px}
canvas{display:block;width:100vw;height:100vh}
footer{position:fixed;right:12px;bottom:12px;color:#888;font-size:12px}
</style>
</head>
<body>
<div class="controls" id="controls">
  <label>動画ファイルを選択<input id="file" type="file" accept="video/*"></label>
  <label>セルサイズ <input id="cellRange" type="range" min="4" max="48" value="12"></label>
  <label>文字セット
    <select id="charset">
      <option value="█▓▒░ .">ブロック</option>
      <option value="あいうえおかきくけこさしすせそたちつてとなにぬねの一二三四五六七八九十百千万億兆京龍竜虎豹狼熊鹿兎猿馬牛羊猪蛇鷹鷲鳩亀蝶蜂蛍蟻蛙鮫鯨鯉鮎鮭鱗牙角翼爪尾甲盾剣槍弓矢鎧兜城塔宮殿寺社橋道街村郷都島嶺丘畑園港湖泉滝渓谷森竹梅桜菊桃梨葡萄柿栗松竹梅梅蘭竹菊仁義礼智忠孝勇義信徳真善美悪罪罰賞誉光闇影幻魔鬼妖霊魂神仏聖帝王后姫臣将兵旗軍騎砲船車鉄鋼銅鏡鐘笛鼓琴笙笛筆墨紙巻書簡詩歌詞曲舞劇絵画彫像図表計算数理科学技術電磁波原子核能機械装置発明発見構造元素粒子分子細胞血脈骨筋脳心肺肝腎胃腸皮毛髪眼耳鼻口歯舌声涙汗笑怒哀楽悲喜炎火煙灰炭油灯炉釜窯鉄鉱鉱石宝珠宝石瑠璃琥珀翡翠真珠珊瑚瑪瑙硝子陶磁器器皿壺瓶箱匣鍵扉窓壁床畳障子屏風棚机椅子床布絹綿麻毛皮衣服帯履帽手袋靴鞄笠傘刀剣短刀太刀薙刀鎌斧槌鋸鎖縄糸針紐綱網籠袋舟艇艦艇潜水艇帆船漁船旅客船列車機関車貨車電車飛行機気球宇宙船衛星惑星恒星銀河天体暦時計刻秒分時暁昼夕夜春分夏至秋分冬至朝夕宵暦祭儀式典舞踏祝祷供養祈願参拝巡礼仮面仮装芝居舞台演劇楽器旋律和音合唱交響曲協奏曲楽譜音符調律拍子声楽歌謡童謡民謡雅楽能狂言落語講談絵巻浮世絵屏風絵山水画花鳥画墨絵彩色版画彫刻塑像仏像銅像石像亜哀挨曖悪握圧扱宛嵐依威為偉違維緯壱逸茨芋咽姻淫陰隠韻右宇羽雨雲営影鋭疫益液演縁艶王央往応押旺横欧殴翁奥憶臆虞渦浦詠閲炎煙猿縁艸遠鉛塩於汚奥憂凹押乙卸恩温穏下化仮何佳加可嘉夏嫁家寡科暇果架歌河火禍稼箇花荷華菓貨課嘩霞蚊俄峨我牙画芽賀雅餓介会解回快戒改怪拐悔海灰界皆絵開階塊楷潰壊懐諧外害街慨概骸涯蓋該鎧劾崖涯垣柿各覚角較閣隔確獲嚇穫学岳楽額顎掛潟括活渇割喝謁褐轄且株刈干刊甘汗缶肝官完寒刊寛幹患感慣憾換敢棺款歓汗環簡観韓艦鑑丸含岸眼岩頑顔願企伎危机奇嬉寄岐希幾忌揮旗既期棋棄機帰毅気汽畿祈季紀規記貴起軌輝飢騎鬼亀偽儀戯技擬欺犠議菊吉喫詰却脚虐逆丘久休及吸宮弓急救朽求泣級糾給旧牛去居巨拒拠挙虚許距魚御漁凶共供協況峡挟狭恐恭胸脅興郷鏡響驚仰仰暁業凝玉勤均巾斤金吟銀九句区苦駆具惧愚虞偶遇隅串屈掘靴繰桑勲君薫訓群軍郡兄刑形径恵慶憩掲携敬景軽傾継詣警鶏芸迎鯨劇撃激隙欠決潔穴結血月件倹健兼券剣圏堅嫌建憲懸拳検権献研絹県肩見謙賢軒遣鍵険顕験元原厳幻弦減源玄現言限個古呼固姑孤己庫弧戸故枯湖股虎誇雇顧鼓五互伍午呉吾後御悟碁語誤護交侯候光公功効勾厚口向后好孔孝宏工巧広康恒抗拘控攻昂更校梗構江洪浩港溝甲皇硬稿紅紘絞綱耕考肯航荒行衡講貢購郊酵鉱鋼降項香高剛号合拷豪克刻告国穀酷黒獄腰込頃今困墾婚恨懇昆混痕紺魂些佐叉左差査沙詐鎖座挫債催再最哉塞妻宰彩才採栽歳済災砕祭斎細菜裁載際剤在材罪財坂阪咲冊刷察拶撮擦札殺雑皿三参山惨散産算蚕賛酸餐斬暫残仕伺使刺司史嗣四士始姿子市師志思指支施旨枝止死氏祉私糸紙紫至試詩資飼誌雌視詞嗣賜雌飼寿需儒囚舟秀臭袖終習衆襲讐蹴酬集住充十従柔渋獣縦重銃叔宿淑祝縮粛塾熟出術述俊春瞬准循旬殉純順準潤盾遵処初所暑庶緒署書諸助叙女序徐除傷償勝匠升召哨商唱奨宵将小少尚床庄廠彰承抄招掌捷昇昭晶松沼消渉焦照症省硝礁祥称章笑紹肖衝訟証詔詳象賞鐘障上丈乗冗剰城場壌嬢常情条浄状畳蒸譲醸錠嘱執失室悉湿疾質実芝舎写射捨赦斜煮社者謝車遮蛇邪借勺尺爵酌釈若寂弱主取守手朱殊狩珠種腫趣寿受呪授需儒樹収周宗就州修愁拾洲秀秋終習臭舟衆襲讐蹴酬集住充十従柔渋獣縦重銃叔宿淑祝縮粛塾熟出術述俊春瞬准循旬殉純順準潤盾遵緒諸助序徐除小尚床彰承招掌昇晶松沼消渉焦照症省硝礁祥称章笑紹肖衝訟証詔詳象賞鐘障嬢常情浄状畳蒸譲醸錠壽壌壕嬌彊廟彝戎戲拏撲擡斃斬曠朧朮權歡歸殲濤瀟灣瀰燦燭爛爨獸璧癲盧瞳矯磯礎禪穎竄籠籤纜罷耀聰聶職聿肅腫膳臟舶艦艱艷藝藩藍蘭藻蘇虞螺蟲蟻蠍蠶衢覽贈贖蹟轍轉轟邊邏醇釀鏡鐵鑄鑑閑闇陛隷霧靂靜韻頻顚顯驗鬱魔鮮鱗鷗鷹鸞黙黛點齋齒龍日月火水木金土山川田石花草木森林空海風雨雷雪雲星光影音色鳥魚犬猫東西南北上下左右大小多少高低長短男女人子父母兄弟姉妹友学校社会国愛心夢希望未来自由平和戦争力強弱春夏秋冬紅白青黄黒緑紫橙茶銀金玉書読話聞食飲走歩飛寝起作働休遊楽人間世界宇宙天地空気時間空間永遠ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz@#WMBHENRXO%&?o;:">いろんなの</option>
      <option value="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz">ABC</option>
      <option value="あいうえおかきくけこさしすせそたちつてとなにぬねの">かな</option>
      <option value="0123456789">数字</option>
    </select>
  </label>
  <label><input id="colorCheck" type="checkbox" checked> 色をつける</label>
  <label><input id="shadowCheck" type="checkbox"> 文字を少し重ねる（立体感）</label>
  <label><input id="loopCheck" type="checkbox" checked> ループ再生</label>
  <label>
    <button id="playBtn">再生 / 一時停止</button>
    <button id="resetBtn">リセット</button>
    <button id="fsBtn">全画面</button>
  </label>
</div>

<canvas id="canvas"></canvas>
<video id="video" hidden playsinline></video>

<script>
const fileInput=document.getElementById('file')
const video=document.getElementById('video')
const canvas=document.getElementById('canvas')
const ctx=canvas.getContext('2d')
const cellRange=document.getElementById('cellRange')
const charsetSel=document.getElementById('charset')
const colorCheck=document.getElementById('colorCheck')
const shadowCheck=document.getElementById('shadowCheck')
const loopCheck=document.getElementById('loopCheck')
const playBtn=document.getElementById('playBtn')
const resetBtn=document.getElementById('resetBtn')
const fsBtn=document.getElementById('fsBtn')
const controls=document.getElementById('controls')

let cellSize=+cellRange.value
let chars=charsetSel.value.split('')
let overlap=false
let rafId
let useVFC=false

fileInput.addEventListener('change',e=>{
  const f=e.target.files[0]
  if(!f) return
  const url=URL.createObjectURL(f)
  video.src=url
  video.load()
  video.addEventListener('loadedmetadata',onMeta,{once:true})
})

cellRange.addEventListener('input',()=>{cellSize=+cellRange.value})
charsetSel.addEventListener('change',()=>{chars=charsetSel.value.split('')})
shadowCheck.addEventListener('change',()=>{overlap=shadowCheck.checked})
loopCheck.addEventListener('change',()=>{video.loop=loopCheck.checked})
playBtn.addEventListener('click',togglePlay)
resetBtn.addEventListener('click',resetAll)

fsBtn.addEventListener('click',()=>{
  if(!document.fullscreenElement){
    document.documentElement.requestFullscreen()
    controls.style.display="none"
  }
})
document.addEventListener('fullscreenchange',()=>{
  if(!document.fullscreenElement){
    controls.style.display="block"
  }
})
document.addEventListener('keydown',e=>{
  if(e.key==='Escape' && document.fullscreenElement){
    document.exitFullscreen()
  }
})

function onMeta(){
  video.loop=loopCheck.checked
  useVFC=!!video.requestVideoFrameCallback
  video.play()
  if(useVFC) video.requestVideoFrameCallback(drawVFC)
  else drawRAF()
}

function drawFrame(){
  if(canvas.width!==video.videoWidth || canvas.height!==video.videoHeight){
    canvas.width=video.videoWidth
    canvas.height=video.videoHeight
  }

  ctx.drawImage(video,0,0,canvas.width,canvas.height)
  const frame=ctx.getImageData(0,0,canvas.width,canvas.height).data
  ctx.clearRect(0,0,canvas.width,canvas.height)
  ctx.font=cellSize+"px monospace"
  ctx.textBaseline="top"
  const step=cellSize
  for(let y=0;y<canvas.height;y+=step){
    for(let x=0;x<canvas.width;x+=step){
      const i=((y*canvas.width)+x)*4
      const r=frame[i],g=frame[i+1],b=frame[i+2]
      const br=r*0.299+g*0.587+b*0.114
      const ci=Math.floor((br/255)*(chars.length-1))
      const ch=chars[chars.length-1-ci]||' '
      ctx.fillStyle=colorCheck.checked?`rgb(${r},${g},${b})`:`rgb(${br},${br},${br})`
      if(overlap){ctx.shadowColor="rgba(0,0,0,0.6)";ctx.shadowBlur=2}else ctx.shadowBlur=0
      ctx.fillText(ch,x,y)
    }
  }
}

function drawVFC(now,meta){
  if(!video.paused && !video.ended){
    drawFrame()
    video.requestVideoFrameCallback(drawVFC)
  }
}

function drawRAF(){
  if(!video.paused && !video.ended){
    drawFrame()
    rafId=requestAnimationFrame(drawRAF)
  }
}

function togglePlay(){
  if(video.paused){
    video.play()
    if(useVFC) video.requestVideoFrameCallback(drawVFC)
    else drawRAF()
  } else video.pause()
}

function resetAll(){
  cancelAnimationFrame(rafId)
  video.pause()
  canvas.width=canvas.height=0
  video.removeAttribute('src')
  fileInput.value=''
}
</script>
</body>
</html>

<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>文字動画</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{margin:0;background:#000;color:#fff;font-family:monospace;overflow:hidden}
.controls{position:fixed;left:12px;top:12px;z-index:30;background:rgba(0,0,0,0.6);padding:10px;border-radius:8px;backdrop-filter: blur(4px);color:#fff}
.controls label{display:block;margin:6px 0;font-size:13px}
.controls input[type="range"]{width:200px}
canvas{display:block;width:100vw;height:100vh}
footer{position:fixed;right:12px;bottom:12px;color:#888;font-size:12px}
</style>
</head>
<body>
<div class="controls" id="controls">
  <label>動画ファイルを選択<input id="file" type="file" accept="video/*"></label>
  <label>セルサイズ <input id="cellRange" type="range" min="4" max="48" value="12"></label>
  <label>文字セット
    <select id="charset">
      <option value="█▓▒░ .">ブロック</option>
      <option value="@#WMBHENRXO%&?*o;:,.">濃淡記号</option>
      <option value="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789">英数</option>
      <option value="あいうえおかきくけこさしすせそたちつてとなにぬねの">かな</option>
      <option value="01">0/1</option>
    </select>
  </label>
  <label><input id="colorCheck" type="checkbox" checked> 色をつける</label>
  <label><input id="shadowCheck" type="checkbox"> 文字を少し重ねる（立体感）</label>
  <label><input id="loopCheck" type="checkbox" checked> ループ再生</label>
  <label>
    <button id="playBtn">再生 / 一時停止</button>
    <button id="resetBtn">リセット</button>
    <button id="fsBtn">全画面</button>
  </label>
</div>

<canvas id="canvas"></canvas>
<video id="video" hidden playsinline muted></video>

<script>
const fileInput=document.getElementById('file')
const video=document.getElementById('video')
const canvas=document.getElementById('canvas')
const ctx=canvas.getContext('2d')
const cellRange=document.getElementById('cellRange')
const charsetSel=document.getElementById('charset')
const colorCheck=document.getElementById('colorCheck')
const shadowCheck=document.getElementById('shadowCheck')
const loopCheck=document.getElementById('loopCheck')
const playBtn=document.getElementById('playBtn')
const resetBtn=document.getElementById('resetBtn')
const fsBtn=document.getElementById('fsBtn')
const controls=document.getElementById('controls')

let cellSize=+cellRange.value
let chars=charsetSel.value.split('')
let overlap=false
let rafId
let useVFC=false

fileInput.addEventListener('change',e=>{
  const f=e.target.files[0]
  if(!f) return
  const url=URL.createObjectURL(f)
  video.src=url
  video.load()
  video.addEventListener('loadedmetadata',onMeta,{once:true})
})

cellRange.addEventListener('input',()=>{cellSize=+cellRange.value})
charsetSel.addEventListener('change',()=>{chars=charsetSel.value.split('')})
shadowCheck.addEventListener('change',()=>{overlap=shadowCheck.checked})
loopCheck.addEventListener('change',()=>{video.loop=loopCheck.checked})
playBtn.addEventListener('click',togglePlay)
resetBtn.addEventListener('click',resetAll)

fsBtn.addEventListener('click',()=>{
  if(!document.fullscreenElement){
    document.documentElement.requestFullscreen()
    controls.style.display="none"
  }
})
document.addEventListener('fullscreenchange',()=>{
  if(!document.fullscreenElement){
    controls.style.display="block"
  }
})
document.addEventListener('keydown',e=>{
  if(e.key==='Escape' && document.fullscreenElement){
    document.exitFullscreen()
  }
})

function onMeta(){
  video.loop=loopCheck.checked
  useVFC=!!video.requestVideoFrameCallback
  video.play()
  if(useVFC) video.requestVideoFrameCallback(drawVFC)
  else drawRAF()
}

function drawFrame(){
  if(canvas.width!==video.videoWidth || canvas.height!==video.videoHeight){
    canvas.width=video.videoWidth
    canvas.height=video.videoHeight
  }

  ctx.drawImage(video,0,0,canvas.width,canvas.height)
  const frame=ctx.getImageData(0,0,canvas.width,canvas.height).data
  ctx.clearRect(0,0,canvas.width,canvas.height)
  ctx.font=cellSize+"px monospace"
  ctx.textBaseline="top"
  const step=cellSize
  for(let y=0;y<canvas.height;y+=step){
    for(let x=0;x<canvas.width;x+=step){
      const i=((y*canvas.width)+x)*4
      const r=frame[i],g=frame[i+1],b=frame[i+2]
      const br=r*0.299+g*0.587+b*0.114
      const ci=Math.floor((br/255)*(chars.length-1))
      const ch=chars[chars.length-1-ci]||' '
      ctx.fillStyle=colorCheck.checked?`rgb(${r},${g},${b})`:`rgb(${br},${br},${br})`
      if(overlap){ctx.shadowColor="rgba(0,0,0,0.6)";ctx.shadowBlur=2}else ctx.shadowBlur=0
      ctx.fillText(ch,x,y)
    }
  }
}

function drawVFC(now,meta){
  if(!video.paused && !video.ended){
    drawFrame()
    video.requestVideoFrameCallback(drawVFC)
  }
}

function drawRAF(){
  if(!video.paused && !video.ended){
    drawFrame()
    rafId=requestAnimationFrame(drawRAF)
  }
}

function togglePlay(){
  if(video.paused){
    video.play()
    if(useVFC) video.requestVideoFrameCallback(drawVFC)
    else drawRAF()
  }else video.pause()
}

function resetAll(){
  cancelAnimationFrame(rafId)
  video.pause()
  canvas.width=canvas.height=0
  video.removeAttribute('src')
  fileInput.value=''
}
</script>
</body>
</html>

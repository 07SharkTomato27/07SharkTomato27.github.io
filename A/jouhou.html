<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>情報</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
:root{--bg:#000;--panel:#111;--muted:#999;--fg:#fff}
html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif}
.header{padding:8px 12px;font-size:15px;background:#060606;border-bottom:1px solid #222}
.container{display:flex;gap:12px;padding:12px;align-items:flex-start}
.left{width:300px;min-width:220px;background:var(--panel);padding:10px;border-radius:8px;height:72vh;overflow:auto}
.mapWrap{flex:1;min-width:300px;height:72vh;border-radius:8px;overflow:hidden;border:1px solid #222}
#map{width:100%;height:100%}
.card{background:#0b0b0b;padding:8px;border-radius:6px;margin-bottom:10px}
.small{font-size:12px;color:var(--muted)}
.kv{display:flex;justify-content:space-between;gap:8px}
.legend{display:flex;gap:6px;align-items:center;margin-top:6px}
.legend .sw{width:18px;height:12px;border-radius:2px}
.l1{background:#1f77ff}
.l2{background:#7fb3ff}
.l3{background:#ffd966}
.l4{background:#ff9b2f}
.l5{background:#ff3b3b}
.l6{background:#9b30ff}
.btn{background:#161616;border:1px solid #333;padding:6px 8px;border-radius:6px;cursor:pointer;color:var(--fg)}
.pre{white-space:pre-wrap;font-family:monospace;font-size:12px;color:#ddd;background:#050505;padding:8px;border-radius:6px;overflow:auto;max-height:220px}
.footer{padding:8px 12px;font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<div class="header">地震・雨雲</div>
<div class="container">
  <div class="left">
    <div class="card">
      <div class="kv"><div class="small">現在時刻</div><div id="clock" class="small">--:--:--</div></div>
      <div style="height:8px"></div>
      <div class="kv"><div class="small">自分のIP</div><div id="ip" class="small">取得中…</div></div>
      <div class="kv"><div class="small">ブラウザ/OS</div><div id="ua" class="small"></div></div>
      <div style="height:8px"></div>
      <div class="kv"><div class="small">ping (api.ipify)</div><div id="pingIp" class="small">-- ms</div></div>
      <div class="kv"><div class="small">ping (気象庁)</div><div id="pingJma" class="small">-- ms</div></div>
      <div style="height:8px"></div>
      <button id="refreshRadar" class="btn">レーダー再取得</button>
    </div>
    <div class="card">
      <div class="small">雨雲強度</div>
      <div class="legend">
        <div class="sw l1"></div><div class="small">弱</div>
        <div class="sw l2"></div><div class="small">やや弱</div>
        <div class="sw l3"></div><div class="small">中</div>
        <div class="sw l4"></div><div class="small">強</div>
        <div class="sw l5"></div><div class="small">非常に強</div>
        <div class="sw l6"></div><div class="small">極めて強</div>
      </div>
    </div>
    <div class="card">
      <div class="small">最新地震</div>
      <div class="pre" id="quakeBox">取得中…</div>
    </div>
  </div>
  <div class="mapWrap">
    <div id="map"></div>
  </div>
</div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const map = L.map('map',{preferCanvas:true,zoomControl:true})
let radarLayer = null
let quakeMarker = null
const clockEl = document.getElementById('clock')
const ipEl = document.getElementById('ip')
const uaEl = document.getElementById('ua')
const pingIpEl = document.getElementById('pingIp')
const pingJmaEl = document.getElementById('pingJma')
const quakeBox = document.getElementById('quakeBox')
uaEl.textContent = navigator.userAgent
function fmtDate(d){return d.toLocaleString('ja-JP',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit'})}
setInterval(()=>{clockEl.textContent = fmtDate(new Date())},250)
async function measurePing(url,labelEl){try{const t0=performance.now();await fetch(url,{cache:'no-store',mode:'cors'});const dt=Math.round(performance.now()-t0);labelEl.textContent=dt+' ms'}catch(e){labelEl.textContent='err'}}
async function fetchNowcTimes(){const r=await fetch('https://www.jma.go.jp/bosai/jmatile/data/nowc/targetTimes_N1.json',{cache:'no-store'});const j=await r.json();return j[0]||j}
async function updateRadar(){try{const t=await fetchNowcTimes();const base=t.basetime,valid=t.validtime;const url=`https://www.jma.go.jp/bosai/jmatile/data/nowc/${base}/none/${valid}/surf/hrpns/{z}/{x}/{y}.png`;if(radarLayer){radarLayer.setUrl(url)}else{radarLayer=L.tileLayer(url,{opacity:0.78,maxNativeZoom:10,maxZoom:14,zIndex:20,crossOrigin:true});radarLayer.addTo(map)}}catch(e){}}
function parseCod(cod){const m=cod&&cod.match(/([+-]\d+\.\d+)([+-]\d+\.\d+)/);return m?{lat:parseFloat(m[1]),lon:parseFloat(m[2])}:null}
async function updateQuake(){try{const r=await fetch('https://www.jma.go.jp/bosai/quake/data/list.json',{cache:'no-store'});const list=await r.json();if(!Array.isArray(list)||!list.length){quakeBox.textContent='地震データなし';return}const q=list[0];let lines=[];const at=q.at||q.ctt;lines.push('発表: '+(at||'---'));lines.push('震源: '+(q.anm||'---'));lines.push('M: '+(q.mag||'---'));lines.push('最大震度: '+(q.maxi||'---'));if(q.depth)lines.push('深さ: '+q.depth);quakeBox.textContent=lines.join('\n');let pos=parseCod(q.cod);if(pos){if(quakeMarker)map.removeLayer(quakeMarker);quakeMarker=L.circleMarker([pos.lat,pos.lon],{radius:Math.max(6,(q.mag||0)*2),color:'#ff4444',fillColor:'#ff8888',fillOpacity:0.9}).addTo(map);quakeMarker.bindPopup(`震源:${q.anm||'--'}<br>M:${q.mag||'--'} 震度:${q.maxi||'--'}<br>${at||''}`)}}catch(e){quakeBox.textContent='取得失敗'}}
document.getElementById('refreshRadar').addEventListener('click',()=>{updateRadar()})
async function init(){navigator.geolocation.getCurrentPosition(pos=>{const lat=pos.coords.latitude,lon=pos.coords.longitude;map.setView([lat,lon],10);L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:''}).addTo(map);L.marker([lat,lon]).addTo(map).bindPopup("現在地").openPopup()});updateRadar();updateQuake();measurePing('https://api.ipify.org?format=json',pingIpEl);measurePing('https://www.jma.go.jp/bosai/jmatile/data/nowc/targetTimes_N1.json',pingJmaEl);setInterval(updateRadar,5*60*1000);setInterval(updateQuake,60*1000);setInterval(()=>{measurePing('https://api.ipify.org?format=json',pingIpEl);measurePing('https://www.jma.go.jp/bosai/jmatile/data/nowc/targetTimes_N1.json',pingJmaEl)},5000)}async function getMyIp(){
  const res = await fetch("https://api.ipify.org?format=json")
  const d = await res.json()
  document.getElementById("ip").textContent = d.ip
}
getMyIp()
init()
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>SharkChat</title>
<link rel="icon" href="icon/favicon3.ico" type="image/x-icon">
<style>
body {
  margin: 0;
  padding: 0;
  font-family: sans-serif;
  background: linear-gradient(to bottom right, #1e1e2f, #3a3a5c);
  color: white;
}
#login {
  display: flex;
  height: 100vh;
  justify-content: center;
  align-items: center;
  flex-direction: column;
}
#app {
  display: none;
  height: 100vh;
}
#main {
  display: flex;
  height: 100%;
}
#channels {
  width: 220px;
  background: #2f3136;
  padding: 10px;
  box-sizing: border-box;
  display: flex;
  flex-direction: column;
  gap: 5px;
}
.channel {
  padding: 5px;
  cursor: pointer;
}
.channel:hover {
  background: #40444b;
}
.active {
  background: #5865f2;
}
#chat {
  flex: 1;
  display: flex;
  flex-direction: column;
  background: #36393f;
}
#chat-header {
  padding: 10px;
  background: #202225;
  border-bottom: 1px solid #444;
}
#messages {
  flex: 1;
  overflow-y: auto;
  padding: 10px;
}
#input-box {
  display: flex;
  border-top: 1px solid #444;
}
#input-box input {
  flex: 1;
  padding: 10px;
  border: none;
}
#input-box button {
  padding: 10px;
  background: #7289da;
  border: none;
  color: white;
}
.msg {
  margin-bottom: 5px;
}
.msg:hover .delete {
  display: inline;
}
.delete {
  display: none;
  color: red;
  cursor: pointer;
  margin-left: 10px;
}
#user-settings {
  margin-bottom: 10px;
  display: flex;
  flex-direction: column;
  gap: 5px;
}
#avatar-preview {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  object-fit: cover;
}
#settings-panel {
  display: none;
  flex-direction: column;
  gap: 5px;
}
.vc-channel {
  background: #2f3136;
  padding: 5px;
  border-radius: 5px;
  margin-top: 5px;
}
.vc-users {
  display: flex;
  gap: 5px;
  margin-top: 5px;
  flex-wrap: wrap;
}
.vc-join-btn {
  margin-top: 5px;
  padding: 3px 6px;
  background: #43b581;
  border: none;
  color: white;
  cursor: pointer;
  border-radius: 3px;
}
.vc-mic-btn {
  margin-top: 5px;
  padding: 3px 6px;
  background: #faa61a;
  border: none;
  color: white;
  cursor: pointer;
  border-radius: 3px;
}
</style>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/peerjs@1.4.7/dist/peerjs.min.js"></script>
</head>
<body>
<div id="login">
<h2>PASS</h2>
<input type="password" id="password" placeholder="パスワード">
<button id="enter-button">入る</button>
</div>

<div id="app">
<div id="main">
<div id="channels">
<h3>SharkChat</h3>
<div id="user-settings">
<input id="username" placeholder="名前を入力">
<input type="file" id="avatar" accept="image/*">
<img id="avatar-preview" src="" alt="avatar">
<button id="settings-button">⚙</button>
</div>
<div id="settings-panel">
<label>フォント: <input id="font-setting" placeholder="例: sans-serif"></label>
<label>メッセージ色: <input id="text-color-setting" type="color"></label>
<label>色1: <input id="color1-setting" type="color"></label>
<label>色2: <input id="color2-setting" type="color"></label>
</div>
<div class="channel active" data-index="0"># 喋る1</div>
<div class="channel" data-index="1"># 速報</div>
<div class="channel" data-index="2"># 喋る2</div>
<div class="channel" data-index="3"># 喋る3</div>
<div class="vc-channel" data-index="0">
VC1
<button class="vc-join-btn">入る/出る</button>
<button class="vc-mic-btn">マイクON</button>
<div class="vc-users"></div>
</div>
<div class="vc-channel" data-index="1">
VC2
<button class="vc-join-btn">入る/出る</button>
<button class="vc-mic-btn">マイクON</button>
<div class="vc-users"></div>
</div>
</div>

<div id="chat">
<div id="chat-header"># 喋る1</div>
<div id="messages"></div>
<div id="input-box">
<input id="msg" placeholder="メッセージを入力">
<button id="send-button">送信</button>
</div>
</div>
</div>
</div>

<script>
const firebaseConfig = {
apiKey:"AIzaSyCPF0ieugcs05fLXYahHdaE5JCeXgOIw3A",
authDomain:"sharkchat-9a0a5.firebaseapp.com",
databaseURL:"https://sharkchat-9a0a5-default-rtdb.firebaseio.com",
projectId:"sharkchat-9a0a5",
storageBucket:"sharkchat-9a0a5.appspot.com",
messagingSenderId:"932358584876",
appId:"1:932358584876:web:afa8b9f8515c0ac6826f89"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let username = localStorage.getItem("username")||"名無し";
let avatarURL = localStorage.getItem("avatarURL")||"";
let currentChannel=0;
let currentRef=null;
let inVC=false;
let vcStream=null;
let micOn=true;

function playEnter(){ const a=new Audio("media/chat/hairu.mp3"); a.play(); }
function playLeave(){ const a=new Audio("media/chat/deru.mp3"); a.play(); }
function playNotify(){ const a=new Audio("media/chat/tuuti.mp3"); a.play(); }
let pageHidden=false;

function applySettings(){
const font=localStorage.getItem("font")||"sans-serif";
const color1=localStorage.getItem("color1")||"#1e1e2f";
const color2=localStorage.getItem("color2")||"#3a3a5c";
const textColor=localStorage.getItem("textColor")||"white";
document.body.style.fontFamily=font;
document.getElementById("chat").style.background=`linear-gradient(to bottom right, ${color1}, ${color2})`;
document.body.style.color=textColor;
}

document.addEventListener("DOMContentLoaded",()=>{
  if("Notification" in window){
    if(Notification.permission==="default"){
      Notification.requestPermission();
    }
  }
});

document.addEventListener("visibilitychange",()=>{pageHidden=document.hidden;});
function showNotification(m){
  if (!pageHidden) return;
  if (Notification.permission==="granted"){
    new Notification(m.name,{body:m.text,icon:m.avatar});
  }
}

function checkPass(){
const pass=document.getElementById('password').value;
if(pass==="0727"){
document.getElementById('login').style.display="none";
document.getElementById('app').style.display="block";
document.getElementById('username').value=username;
if(avatarURL) document.getElementById('avatar-preview').src=avatarURL;
document.getElementById("font-setting").value=localStorage.getItem("font")||"";
document.getElementById("text-color-setting").value=localStorage.getItem("textColor")||"#ffffff";
document.getElementById("color1-setting").value=localStorage.getItem("color1")||"#1e1e2f";
document.getElementById("color2-setting").value=localStorage.getItem("color2")||"#3a3a5c";
applySettings();
listenMessages();
} else {alert("間違ったパスワード");}
}

function setUsername(){
const input=document.getElementById('username').value;
if(input.trim()!==""){username=input.trim();localStorage.setItem("username",username);}
}

function setAvatar(){
const file=document.getElementById('avatar').files[0];
if(!file)return;
const reader=new FileReader();
reader.onload=function(e){avatarURL=e.target.result;document.getElementById('avatar-preview').src=avatarURL;localStorage.setItem("avatarURL",avatarURL);};
reader.readAsDataURL(file);
}

function switchChannel(index){
currentChannel=index;
document.getElementById("chat-header").textContent=["# 喋る1","# 速報","# 喋る2","# 喋る3"][index]||"# 喋る1";
document.querySelectorAll(".channel").forEach((el,i)=>{el.classList.toggle("active",i===index);});
listenMessages();
updateVCDisplay();
}

function sendMsg(){
const input=document.getElementById('msg');
if(input.value.trim()==="") return;
const msg={name:username,avatar:avatarURL,text:input.value.trim(),timestamp:Date.now()};
db.ref("channel"+currentChannel).push(msg);
input.value="";
}

function deleteMsg(key, name){
  if(name==="SharkTomato" || username==="SharkTomato"){
    for(let i=0;i<4;i++){
      db.ref("channel"+i+"/"+key).remove();
    }
  }
}

function listenMessages(){
  if(currentRef) currentRef.off();
  currentRef=db.ref("channel"+currentChannel);

  currentRef.on("value",snap=>{
    const container=document.getElementById('messages');
    const data=snap.val()||{};
    const prevIds = Array.from(container.querySelectorAll(".msg")).map(el=>el.dataset.id);

    container.innerHTML=Object.entries(data).map(([key,m])=>{
      const date=new Date(m.timestamp);
      const dateStr=`${date.getFullYear()}/${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${date.getMinutes().toString().padStart(2,'0')}`;
      return `<div class="msg" data-id="${key}">
        <img src="${m.avatar}" width="30" height="30" style="vertical-align: middle; border-radius:50%">
        <b>${m.name}:</b> ${m.text} 
        <span style="font-size:0.8em;color:#aaa">(${dateStr})</span>
        ${(m.name===username || username==="SharkTomato")?`<span class="delete" onclick="deleteMsg('${key}','${m.name}')">[削除]</span>`:""}
      </div>`;
    }).join("");

    const newIds = Object.keys(data);
    newIds.forEach(id=>{
      if(!prevIds.includes(id) && pageHidden){
        playNotify();

        if("Notification" in window && Notification.permission==="granted"){
          const m = data[id];
          new Notification(m.name,{
            body: m.text,
            icon: m.avatar || "icon/favicon3.ico"
          });
        }
      }
    });

    container.scrollTop=container.scrollHeight;
  });
}

function updateVCDisplay(){
document.querySelectorAll(".vc-channel").forEach((vc,idx)=>{
const usersDiv=vc.querySelector(".vc-users");
db.ref("vc"+idx).once("value",snap=>{
const data=snap.val()||{};
usersDiv.innerHTML=Object.values(data).map(u=>`<img src="${u.avatar}" title="${u.name}" style="width:36px;height:36px;border-radius:50%">`).join("");
});
});
}

document.addEventListener("DOMContentLoaded",()=>{
document.getElementById("enter-button").addEventListener("click",checkPass);
document.getElementById("username").addEventListener("change",setUsername);
document.getElementById("avatar").addEventListener("change",setAvatar);
document.querySelectorAll(".channel").forEach(el=>{el.addEventListener("click",()=>{switchChannel(parseInt(el.dataset.index));});});
document.getElementById("password").addEventListener("keydown",e=>{if(e.key==="Enter") checkPass();});
document.getElementById("msg").addEventListener("keydown",e=>{if(e.key==="Enter") sendMsg();});
document.getElementById("settings-button").addEventListener("click",()=>{const panel=document.getElementById("settings-panel");panel.style.display=panel.style.display==="flex"?"none":"flex";});
document.getElementById("font-setting").addEventListener("change",e=>{localStorage.setItem("font",e.target.value);applySettings();});
document.getElementById("text-color-setting").addEventListener("change",e=>{localStorage.setItem("textColor",e.target.value);applySettings();});
document.getElementById("color1-setting").addEventListener("change",e=>{localStorage.setItem("color1",e.target.value);applySettings();});
document.getElementById("color2-setting").addEventListener("change",e=>{localStorage.setItem("color2",e.target.value);applySettings();});
applySettings();5  
  
let peer = new Peer(username);
let localStream;
let vcStates = {};

document.querySelectorAll(".vc-join-btn").forEach((btn, idx) => {
  const vcChannel = document.querySelectorAll(".vc-channel")[idx];
  const usersDiv = vcChannel.querySelector(".vc-users");
  const micBtn = vcChannel.querySelector(".vc-mic-btn");
  const channelName = "vc" + idx;

  micBtn.addEventListener("click", () => {
    if (!localStream) return;
    localStream.getAudioTracks().forEach(t => t.enabled = !t.enabled);
    micBtn.textContent = localStream.getAudioTracks()[0].enabled ? "マイクON" : "マイクOFF";
  });

  btn.addEventListener("click", async () => {
    if (!inVC) {
      localStream = await navigator.mediaDevices.getUserMedia({ audio: true });

      peer.on("call", call => {
        call.answer(localStream);
        call.on("stream", remoteStream => {
          const audio = document.createElement("audio");
          audio.srcObject = remoteStream;
          audio.autoplay = true;
          vcChannel.appendChild(audio);
        });
      });

      await db.ref(channelName + "/" + peer.id).set({
        name: username,
        avatar: avatarURL,
        id: peer.id
      });
      db.ref(channelName + "/" + peer.id).onDisconnect().remove();

      db.ref(channelName).on("value", snap => {
        const data = snap.val() || {};
        usersDiv.innerHTML = Object.values(data).map(u =>
          `<img src="${u.avatar}" title="${u.name}" style="width:36px;height:36px;border-radius:50%">`
        ).join("");

        Object.values(data).forEach(u => {
          if (u.id && u.id !== peer.id) {
            const call = peer.call(u.id, localStream);
            call.on("stream", s => {
              const audio = document.createElement("audio");
              audio.srcObject = s;
              audio.autoplay = true;
              vcChannel.appendChild(audio);
            });
          }
        });
      });

      inVC = true;
    } else {
      if (localStream) localStream.getTracks().forEach(t => t.stop());
      await db.ref(channelName + "/" + peer.id).remove();
      inVC = false;
    }
  });
});
document.addEventListener("visibilitychange",()=>{pageHidden=document.hidden;});
});
</script>
</body>
</html>
